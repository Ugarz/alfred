# Alfred's Architecture

This document describes the technical architecture of the Discord bot "Alfred," its main components, and how they interact.

## 1. Overview

Alfred is a Discord bot designed with **[Discord.js](https://discord.js.org/)**, a powerful Node.js framework for interacting with the Discord API. The bot is written in **TypeScript**, which ensures typed, more robust, and easier-to-maintain code.

Its mission is to provide useful and entertainment features to the servers on which it is installed. It handles commands (slash commands), listens for Discord events, and can execute tasks at regular intervals.

## 2. Core Technologies

- **Node.js**: Server-side JavaScript runtime environment.
- **TypeScript**: A superset of JavaScript that adds static typing.
- **Discord.js**: The main framework for communication with the Discord API.
- **Drizzle ORM**: A "headless" ORM for TypeScript, used to interact with the database. It is configured for use with SQLite.
- **SQLite**: A lightweight database, stored in the `alfred.db` file, ideal for quick startup and simple deployment.

## 3. Project Structure

The file organization is designed to clearly separate responsibilities:

```
/
├── drizzle/              # Database migrations generated by Drizzle
├── src/
│   ├── commands/         # Bot command files (slash commands)
│   ├── crons/            # Scheduled tasks (e.g., checking daily birthdays)
│   ├── db/               # Database configuration (schema, connection)
│   ├── events/           # Discord event handlers (e.g., new member)
│   ├── i18n/             # Internationalization files
│   └── utils/            # Utility functions, types, and constants
├── .gitignore            # Files ignored by Git
├── package.json          # Project dependencies and scripts
└── tsconfig.json         # TypeScript compiler configuration
```

## 4. Key Components

### 4.1. Command Handling

The bot uses Discord's **slash commands**.
- **Definition**: Each command is defined in its own file in `src/commands/`. Commands are grouped by category (e.g., `fun`, `utility`).
- **Registration**: The `src/deploy-commands.ts` script is responsible for registering commands with the Discord API.
- **Execution**: The main file (`src/index.ts`) listens for command interactions and executes the corresponding code via a command handler.

### 4.1.1. Deploying Commands

To make slash commands available in Discord, they must be "deployed" to Discord's API. This process tells Discord what commands your bot has and what they look like.

The `src/deploy-commands.ts` script handles this process. When executed, it performs the following steps:

1.  **Reads Command Files**: The script recursively reads all `.ts` files from the `src/commands` directory.
2.  **Extracts Command Data**: For each command file, it imports the module and accesses the `data` property, which should be a `SlashCommandBuilder` instance. This object contains the command's definition (name, description, options).
3.  **Builds a List of Commands**: It converts each command's data to a JSON object and collects them in a list.
4.  **Sends to Discord API**: Using the `REST` module from `discord.js`, it makes an HTTP `PUT` request to Discord's API endpoint for registering guild-specific commands (`/applications/{clientId}/guilds/{guildId}/commands`). This request sends the complete list of commands, overwriting any previously registered commands for that guild.

This script is typically run once during setup or whenever you add or modify a command's definition. It needs environment variables like `TOKEN`, `CLIENT_ID`, and `GUILD_ID` to authenticate with Discord.

### 4.2. Database Interaction (Drizzle ORM)

Data persistence is managed by Drizzle ORM with an SQLite database.
- **Schema**: The table structure is defined in `src/db/schema.ts`. This is the single source of truth for the data structure.
- **Connection and Queries**: `src/db/index.ts` initializes the database connection and exports the Drizzle `db` instance. It also exposes specific functions (like `storeBirthday`) to abstract query logic.
- **Migrations**: The `drizzle/` folder contains SQL migration files. These files are essential and must be versioned. They describe how to evolve the database schema sequentially.

| Drizzle Command           | Description                                    |
| :------------------------ | :--------------------------------------------- |
| `npx drizzle-kit generate`| Generates a new SQL migration                  |
| `npx drizzle-kit push`    | Pushes schema changes to the database (for development) |
| `npx drizzle-kit studio`  | Launches a web interface to explore the database |

### 4.3. Scheduled Tasks (Crons)

The `src/crons/` folder contains scripts intended to be executed periodically (e.g., every morning at 9 AM). An example of use would be to announce daily birthdays.

### 4.4. Event Handling

The bot can react to Discord events other than commands, such as a new member joining the server. The logic for these events is managed in the `src/events/` folder.

## 5. Data Flow: Example with the `/bday set` command

To illustrate how the components interact, here's the journey of a command to set a birthday:
1.  **User**: Types the command `/bday set day:15 month:10` on Discord.
2.  **Discord API**: Sends an `InteractionCreate` event to the bot.
3.  **Bot (index.ts)**: Receives the interaction. The command handler identifies it as the `bday` command.
4.  **Command (bday.ts)**: The `src/commands/bday/bday.ts` file is executed. It validates the options (day, month).
5.  **Database (db/index.ts)**: The command calls the `storeBirthday(userId, day, month)` function imported from `src/db/index.ts`.
6.  **Drizzle ORM**: The `storeBirthday` function executes an "upsert" query (INSERT ... ON CONFLICT DO UPDATE) on the `users` table of the `alfred.db` database.
7.  **Response**: The `bday.ts` command sends a confirmation response to the user via an interaction reply.

## 6. Project Context
- [Agent Context](../AGENTS.md)